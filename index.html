<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>پیش‌بینی قیمت خودرو</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');
    body {
      font-family: 'Vazirmatn', sans-serif;
    }
    
    /* استایل برای اسکرول بار */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50">
  <div class="min-h-screen flex flex-col items-center justify-center p-4">
    <!-- هدر -->
    <div class="text-center mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">
        <i class="fas fa-car text-blue-600 ml-2"></i>
        پیش‌بینی قیمت خودرو
      </h1>
      <p class="text-gray-600">با استفاده از هوش مصنوعی و یادگیری ماشین</p>
    </div>

    <div class="flex flex-col lg:flex-row gap-6 w-full max-w-6xl">
      <!-- کارت فرم سمت چپ -->
      <div class="lg:w-1/2">
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 h-full">
          <div class="flex items-center mb-6">
            <div class="bg-blue-100 p-3 rounded-full">
              <i class="fas fa-sliders-h text-blue-600 text-xl"></i>
            </div>
            <h2 class="text-xl font-bold mr-3">مشخصات خودرو</h2>
          </div>
          
          <form id="carForm" class="space-y-5">
            <!-- سطر اول -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
              <!-- خودرو -->
              <div class="relative">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-car ml-1 text-blue-500"></i>
                  نام خودرو
                </label>
                <div class="relative">
                  <select name="car_name" id="car_name" class="w-full border border-gray-300 rounded-lg px-4 py-3 pr-10 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition appearance-none bg-white" required>
                    <option value="">انتخاب کنید</option>
                  </select>
                  <div class="absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                    <i class="fas fa-chevron-down text-gray-400"></i>
                  </div>
                </div>
              </div>

              <!-- مدل -->
              <div class="relative">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-list-alt ml-1 text-blue-500"></i>
                  مدل
                </label>
                <div class="relative">
                  <select name="model" id="model" class="w-full border border-gray-300 rounded-lg px-4 py-3 pr-10 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition appearance-none bg-white" required>
                    <option value="">ابتدا خودرو را انتخاب کنید</option>
                  </select>
                  <div class="absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                    <i class="fas fa-chevron-down text-gray-400"></i>
                  </div>
                </div>
              </div>
            </div>

            <!-- سطر دوم -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
              <!-- سال -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-calendar-alt ml-1 text-blue-500"></i>
                  سال ساخت
                </label>
                <div class="relative">
                  <input type="number" name="year" id="year" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="مثلاً 1401" min="1350" max="1404" required>
                  <div class="absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                    <i class="far fa-calendar text-gray-400"></i>
                  </div>
                </div>
              </div>

              <!-- کیلومتر -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-tachometer-alt ml-1 text-blue-500"></i>
                  کیلومتر
                </label>
                <div class="relative">
                  <input type="number" name="kilometer" id="kilometer" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="مثلاً 58000" min="0" required>
                  <div class="absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                    <i class="fas fa-road text-gray-400"></i>
                  </div>
                </div>
              </div>
            </div>

            <!-- سطر سوم -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
              <!-- رنگ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-palette ml-1 text-blue-500"></i>
                  رنگ
                </label>
                <select name="color" id="color" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                  <option value="سفید">سفید</option>
                  <option value="مشکی">مشکی</option>
                  <option value="نقره‌ای">نقره‌ای</option>
                  <option value="قرمز">قرمز</option>
                  <option value="خاکستری">خاکستری</option>
                  <option value="بژ">بژ</option>
                  <option value="آبی">آبی</option>
                  <option value="قهوه‌ای">قهوه‌ای</option>
                  <option value="سبز">سبز</option>
                  <option value="زرد">زرد</option>
                  <option value="بنفش">بنفش</option>
                </select>
              </div>

              <!-- گیربکس -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-cogs ml-1 text-blue-500"></i>
                  گیربکس
                </label>
                <select name="gearbox" id="gearbox" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required>
                  <option value="">انتخاب کنید</option>
                  <option value="دنده‌ای">دنده‌ای</option>
                  <option value="اتوماتیک">اتوماتیک</option>
                </select>
              </div>
            </div>

            <!-- سطر چهارم -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
              <!-- سوخت -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-gas-pump ml-1 text-blue-500"></i>
                  سوخت
                </label>
                <select name="fuel" id="fuel" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required>
                  <option value="">انتخاب کنید</option>
                  <option value="بنزینی">بنزینی</option>
                  <option value="دوگانه سوز">دوگانه سوز</option>
                </select>
              </div>

              <!-- وضعیت بدنه -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-car-crash ml-1 text-blue-500"></i>
                  وضعیت بدنه
                </label>
                <select name="body_status" id="body_status" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required>
                  <option value="">انتخاب کنید</option>
                  <option value="سالم بدون خط و خش">سالم بدون خط و خش</option>
                  <option value="سالم با خط و خش">سالم با خط و خش</option>
                  <option value="یک لکه رنگ">یک لکه رنگ</option>
                  <option value="دو لکه رنگ">دو لکه رنگ</option>
                  <option value="چند لکه رنگ">چند لکه رنگ</option>
                  <option value="تصادفی">تصادفی</option>
                </select>
              </div>
            </div>

            <!-- دکمه ارسال -->
            <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3.5 rounded-xl font-bold text-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-300 shadow-lg hover:shadow-xl mt-2">
              <i class="fas fa-chart-line ml-2"></i>
              پیش‌بینی قیمت
            </button>
          </form>

          <!-- نتیجه پیش‌بینی -->
          <div id="result" class="mt-8 hidden">
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-5">
              <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-poll ml-2 text-green-600"></i>
                نتیجه پیش‌بینی
              </h3>
              <div id="priceResult" class="text-center">
                <!-- قیمت اینجا نمایش داده می‌شود -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- کارت اطلاعات مدل و نمودار سمت راست -->
      <div class="lg:w-1/2">
        <!-- کارت دقت مدل -->
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 mb-6">
          <div class="flex items-center mb-6">
            <div class="bg-purple-100 p-3 rounded-full">
              <i class="fas fa-brain text-purple-600 text-xl"></i>
            </div>
            <h2 class="text-xl font-bold mr-3">دقت مدل پیش‌بینی</h2>
          </div>
          
          <div id="modelAccuracy" class="text-center py-4">
            <div class="flex justify-center mb-4">
              <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>
            </div>
            <p class="text-gray-600">در حال دریافت اطلاعات دقت مدل...</p>
          </div>

          <!-- معیارهای دقت -->
          <div id="accuracyMetrics" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6 hidden">
            <!-- معیارها اینجا به صورت داینامیک پر می‌شوند -->
          </div>
        </div>

        <!-- کارت نمودار -->
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
          <div class="flex items-center mb-6">
            <div class="bg-amber-100 p-3 rounded-full">
              <i class="fas fa-chart-bar text-amber-600 text-xl"></i>
            </div>
            <h2 class="text-xl font-bold mr-3">توزیع قیمت‌های پیش‌بینی شده</h2>
          </div>
          
          <div class="relative h-72 md:h-80">
            <canvas id="priceChart"></canvas>
          </div>
          
          <div class="mt-6 text-center text-sm text-gray-500">
            <i class="fas fa-info-circle ml-1"></i>
            نمودار بالا بر اساس پیش‌بینی‌های اخیر مدل تولید شده است
          </div>
        </div>
      </div>
    </div>

    <!-- فوتر -->
    <div class="mt-8 text-center text-gray-500 text-sm">
      <p>سامانه پیش‌بینی قیمت خودرو | با استفاده از الگوریتم‌های پیشرفته یادگیری ماشین</p>
      <p class="mt-1">تمامی محاسبات بر اساس داده‌های واقعی بازار انجام می‌شود</p>
    </div>
  </div>

  <script>
    // لیست خودروها
    const cars = [
      "اطلس","تارا","دنا","رانا","ساینا","سمند","شاهین","پراید","پژو","کوییک"
    ];

    // لیست مدل‌ها
    const models = {
      "اطلس":["E","G","S"],
      "تارا":["G","v۱ پلاس","اتوماتیک","دنده ای","وی ۴ ال ایکس"],
      "دنا":["G","دنا پلاس","دنا پلاس توربو","دنا پلاس تیپ ۱ توربو","دنا پلاس تیپ ۱ دنده‌ای","دنا پلاس تیپ ۲ توربو","دنا پلاس تیپ ۲ دنده‌ای","دنا پلاس ۵ دنده توربو","دنا پلاس ۶ دنده توربو","معمولی تیپ ۱","معمولی تیپ ۲"],
      "رانا":["EL","LX","پلاس","پلاس پانوراما"],
      "ساینا":["G","GX","دنده ای","ساینا اتوماتیک EX","ساینا اتوماتیک S","ساینا دنده ای EX","ساینا دنده ای G","ساینا دنده ای S","ساینا دنده ای SX"],
      "سمند":["EL (بنزینی)","EL (دوگانه سوز)","LX (ساده)","LX EF۷ (بنزینی)","LX EF۷ (دوگانه سوز)","SE","X۷ (بنزینی)","X۷ (دوگانه سوز)","سریر","سورن (ELX توربو)","سورن (ELX)","سورن (ساده)","سورن (پلاس)","معمولی"],
      "شاهین":["G","GL","پلاس"],
      "پراید":["سفری","صبا (صندوقدار) (دوگانه سوز)","صبا (صندوقدار) بنزینی","نسیم (هاچ بک)","وانت (۱۵۱) (بنزینی)","وانت (۱۵۱) (پلاس)","وانت ۱۵۱ (دوگانه سوز)","۱۱۱","۱۱۱ se","۱۱۱ sl","۱۱۱ sx","۱۳۱ (بنزینی)","۱۳۱ (دوگانه سوز)","۱۳۱ se","۱۳۱ sl","۱۳۱ sx","۱۳۱ tl","۱۳۲ (بنزینی)","۱۳۲ (دوگانه سوز)","۱۳۲ se","۱۴۱ (بنزینی)","۱۴۱ (دوگانه سوز)","۱۴۱ i","۱۴۱ le","۱۴۱ sx"],
      "پژو":["۲۰۶ (تیپ۱)","۲۰۶ (تیپ۲)","۲۰۶ (تیپ۳)","۲۰۶ (تیپ۳) پانوراما","۲۰۶ (تیپ۴)","۲۰۶ (تیپ۵)","۲۰۶ (تیپ۶)","۲۰۷i (MC)","۲۰۷i (اتوماتیک)","۲۰۷i (دنده ای)","۲۰۷i (پانوراما اتوماتیک TU۵)","۲۰۷i (پانوراما دنده ای)","۲۰۷i دنده‌ای TU۳","۲۰۷i پانوراما اتوماتیک"],
      "کوییک":["G","R","R پلاس","S","اتوماتیک R پلاس","اتوماتیک S","اتوماتیک فول پلاس","ساده","پلاس"]
    };

    // متغیرهای جهانی
    let priceChart = null;
    let accuracyData = {};

    // پر کردن خودروها
    const carSelect = document.getElementById("car_name");
    const modelSelect = document.getElementById("model");

    // پر کردن لیست خودروها
    cars.forEach(car => {
      const option = document.createElement("option");
      option.value = car;
      option.textContent = car;
      carSelect.appendChild(option);
    });

    // تغییر مدل‌ها با انتخاب خودرو
    carSelect.addEventListener("change", () => {
      const car = carSelect.value;
      modelSelect.innerHTML = '<option value="">انتخاب مدل</option>';
      if(models[car]){
        models[car].forEach(m => {
          const opt = document.createElement("option");
          opt.value = m;
          opt.textContent = m;
          modelSelect.appendChild(opt);
        });
      }
    });

    // پر کردن مقادیر پیش‌فرض برای تست
    function fillTestData() {
      // فقط برای محیط توسعه
      if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
        document.getElementById("car_name").value = "پژو";
        document.getElementById("car_name").dispatchEvent(new Event("change"));
        
        setTimeout(() => {
          document.getElementById("model").value = "۲۰۶ (تیپ۲)";
          document.getElementById("year").value = 1398;
          document.getElementById("kilometer").value = 85000;
          document.getElementById("color").value = "سفید";
          document.getElementById("gearbox").value = "دنده‌ای";
          document.getElementById("fuel").value = "بنزینی";
          document.getElementById("body_status").value = "سالم با خط و خش";
        }, 100);
      }
    }

    // دریافت اطلاعات دقت مدل
    async function loadModelAccuracy() {
      try {
        const response = await fetch("https://web-production-3e601.up.railway.app/accuracy", {
          method: "GET",
          headers: { "Content-Type": "application/json" }
        });
        
        if (!response.ok) {
          throw new Error(`خطا در دریافت دقت مدل: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
          accuracyData = result;
          displayAccuracyMetrics(result);
        } else {
          displayDefaultAccuracy();
        }
      } catch (error) {
        console.log("خطا در دریافت دقت مدل، استفاده از داده‌های نمونه");
        displayDefaultAccuracy();
      }
      
      // در هر صورت نمودار را ایجاد کن
      setTimeout(() => {
        generateSampleChart();
      }, 500);
    }

    // نمایش معیارهای دقت
    function displayAccuracyMetrics(data) {
      const metricsContainer = document.getElementById("accuracyMetrics");
      const accuracyEl = document.getElementById("modelAccuracy");
      
      // پاک کردن spinner
      accuracyEl.innerHTML = '';
      
      // نمایش معیارها
      metricsContainer.innerHTML = '';
      metricsContainer.classList.remove("hidden");
      
      // داده‌های نمونه اگر داده واقعی وجود نداشت
      const metricsData = {
        accuracy: data.accuracy || 0.87,
        r2_score: data.r2_score || 0.85,
        mae: data.mae || 15.2,
        rmse: data.rmse || 22.5
      };
      
      // تعریف معیارها با آیکون و رنگ مناسب
      const metrics = [
        { 
          key: 'accuracy', 
          label: 'دقت کلی', 
          icon: 'fas fa-bullseye', 
          color: 'green',
          value: (metricsData.accuracy * 100).toFixed(1) + '%'
        },
        { 
          key: 'r2_score', 
          label: 'ضریب تعیین', 
          icon: 'fas fa-chart-line', 
          color: 'blue',
          value: (metricsData.r2_score * 100).toFixed(1) + '%'
        },
        { 
          key: 'mae', 
          label: 'میانگین خطای مطلق', 
          icon: 'fas fa-exclamation-triangle', 
          color: 'orange',
          value: metricsData.mae.toFixed(2) + 'M'
        },
        { 
          key: 'rmse', 
          label: 'ریشه خطای مربعات', 
          icon: 'fas fa-square-root-alt', 
          color: 'red',
          value: metricsData.rmse.toFixed(2) + 'M'
        }
      ];
      
      metrics.forEach(metric => {
        const metricEl = document.createElement("div");
        metricEl.className = `text-center p-4 rounded-xl border ${getColorClass(metric.color, 'border')} ${getColorClass(metric.color, 'bg')}`;
        metricEl.innerHTML = `
          <div class="text-2xl font-bold ${getColorClass(metric.color, 'text')} mb-2">${metric.value}</div>
          <div class="flex items-center justify-center text-gray-700">
            <i class="${metric.icon} ml-2 ${getColorClass(metric.color, 'text')}"></i>
            <span>${metric.label}</span>
          </div>
        `;
        metricsContainer.appendChild(metricEl);
      });
    }

    // تابع کمکی برای کلاس‌های رنگ
    function getColorClass(color, type) {
      const classes = {
        green: {
          text: 'text-green-600',
          bg: 'bg-green-50',
          border: 'border-green-200'
        },
        blue: {
          text: 'text-blue-600',
          bg: 'bg-blue-50',
          border: 'border-blue-200'
        },
        orange: {
          text: 'text-orange-600',
          bg: 'bg-orange-50',
          border: 'border-orange-200'
        },
        red: {
          text: 'text-red-600',
          bg: 'bg-red-50',
          border: 'border-red-200'
        }
      };
      return classes[color] ? classes[color][type] : '';
    }

    // نمایش دقت پیش‌فرض در صورت خطا
    function displayDefaultAccuracy() {
      const accuracyEl = document.getElementById("modelAccuracy");
      accuracyEl.innerHTML = `
        <div class="text-center py-4">
          <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
            <i class="fas fa-robot text-blue-600 text-2xl"></i>
          </div>
          <h3 class="text-lg font-bold text-gray-800 mb-2">مدل پیش‌بینی قیمت</h3>
          <p class="text-gray-600 mb-3">مدل مبتنی بر الگوریتم رگرسیون</p>
          <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <p class="text-sm text-gray-700"><i class="fas fa-info-circle ml-1 text-blue-500"></i> دقت مدل بر اساس داده‌های تاریخی بازار خودرو محاسبه شده است</p>
          </div>
        </div>
      `;
    }

    // ایجاد نمودار نمونه
    function generateSampleChart() {
      const ctx = document.getElementById('priceChart');
      
      if (!ctx) {
        console.error("عنصر canvas با id='priceChart' یافت نشد!");
        return;
      }
      
      // تخریب نمودار قبلی اگر وجود دارد
      if (priceChart) {
        priceChart.destroy();
      }
      
      // داده‌های نمونه برای نمودار
      const labels = ['زیر ۲۰۰', '۲۰۰-۴۰۰', '۴۰۰-۶۰۰', '۶۰۰-۸۰۰', '۸۰۰-۱۰۰۰', 'بالای ۱۰۰۰'];
      const data = [15, 28, 35, 22, 12, 8];
      const backgroundColors = [
        'rgba(59, 130, 246, 0.7)',
        'rgba(16, 185, 129, 0.7)',
        'rgba(245, 158, 11, 0.7)',
        'rgba(139, 92, 246, 0.7)',
        'rgba(239, 68, 68, 0.7)',
        'rgba(99, 102, 241, 0.7)'
      ];
      
      // ایجاد نمودار جدید
      try {
        priceChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels.map(label => label + ' میلیون'),
            datasets: [{
              label: 'تعداد پیش‌بینی‌ها',
              data: data,
              backgroundColor: backgroundColors,
              borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
              borderWidth: 1,
              borderRadius: 8,
              borderSkipped: false,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                rtl: true,
                labels: {
                  font: {
                    family: 'Vazirmatn, sans-serif',
                    size: 14
                  },
                  padding: 20
                }
              },
              tooltip: {
                rtl: true,
                titleFont: {
                  family: 'Vazirmatn, sans-serif'
                },
                bodyFont: {
                  family: 'Vazirmatn, sans-serif'
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  font: {
                    family: 'Vazirmatn, sans-serif'
                  }
                },
                title: {
                  display: true,
                  text: 'تعداد',
                  font: {
                    family: 'Vazirmatn, sans-serif',
                    size: 14
                  }
                }
              },
              x: {
                ticks: {
                  font: {
                    family: 'Vazirmatn, sans-serif'
                  }
                },
                title: {
                  display: true,
                  text: 'محدوده قیمت (میلیون تومان)',
                  font: {
                    family: 'Vazirmatn, sans-serif',
                    size: 14
                  }
                }
              }
            }
          }
        });
        console.log("نمودار با موفقیت ایجاد شد");
      } catch (error) {
        console.error("خطا در ایجاد نمودار:", error);
      }
    }

    // فرمت کردن عدد با جداکننده هزارگان
    function formatPrice(price) {
      return new Intl.NumberFormat('fa-IR').format(price);
    }

    // اعتبارسنجی فرم
    function validateForm() {
      const year = parseInt(document.getElementById('year').value);
      const kilometer = parseInt(document.getElementById('kilometer').value);
      
      if (year < 1350 || year > 1404) {
        showNotification('سال ساخت باید بین ۱۳۵۰ تا ۱۴۰۴ باشد', 'error');
        return false;
      }
      
      if (kilometer < 0) {
        showNotification('کیلومتر نمی‌تواند منفی باشد', 'error');
        return false;
      }
      
      return true;
    }

    // ارسال فرم
    const form = document.getElementById('carForm');
    const resultDiv = document.getElementById('result');
    const priceResultDiv = document.getElementById('priceResult');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // اعتبارسنجی
      if (!validateForm()) {
        return;
      }
      
      // نمایش loading
      resultDiv.classList.remove('hidden');
      priceResultDiv.innerHTML = `
        <div class="flex flex-col items-center justify-center py-8">
          <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mb-4"></div>
          <p class="text-gray-600">در حال محاسبه قیمت...</p>
          <p class="text-sm text-gray-500 mt-2">لطفاً چند لحظه صبر کنید</p>
        </div>
      `;
      
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      // مقادیر عددی و بولی
      data.kilometer = parseInt(data.kilometer);
      data.year = parseInt(data.year);
      data.zero_km = data.kilometer === 0 ? 1 : 0;
      data.km_per_year = Math.floor(data.kilometer / (1404 - data.year || 1));
      data.is_automatic = data.gearbox.includes("اتوماتیک") ? 1 : 0;

      try {
        const response = await fetch("https://web-production-3e601.up.railway.app/predict", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        
        if(result.success){
          const formattedPrice = formatPrice(result.predicted_price);
          
          // نمایش قیمت با استایل زیبا
          priceResultDiv.innerHTML = `
            <div class="text-center">
              <div class="text-4xl md:text-5xl font-bold text-green-600 mb-3">
                ${formattedPrice}
                <span class="text-lg text-gray-600">تومان</span>
              </div>
              <div class="text-gray-700 mb-4">
                <div class="flex items-center justify-center mb-2">
                  <i class="fas fa-check-circle text-green-500 ml-2"></i>
                  <span>پیش‌بینی با موفقیت انجام شد</span>
                </div>
              </div>
              
              <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mt-4">
                <h4 class="font-bold text-gray-800 mb-2">خلاصه مشخصات:</h4>
                <div class="grid grid-cols-2 gap-2 text-sm">
                  <div class="text-gray-600">خودرو:</div>
                  <div class="font-medium">${data.car_name} ${data.model}</div>
                  
                  <div class="text-gray-600">سال ساخت:</div>
                  <div class="font-medium">${data.year}</div>
                  
                  <div class="text-gray-600">کیلومتر:</div>
                  <div class="font-medium">${formatPrice(data.kilometer)}</div>
                  
                  <div class="text-gray-600">گیربکس:</div>
                  <div class="font-medium">${data.gearbox}</div>
                </div>
              </div>
              
              <div class="mt-6">
                <button onclick="updateChartWithPrediction(${result.predicted_price})" class="bg-blue-100 text-blue-700 hover:bg-blue-200 px-4 py-2 rounded-lg text-sm font-medium transition">
                  <i class="fas fa-chart-bar ml-1"></i>
                  به‌روزرسانی نمودار با این پیش‌بینی
                </button>
              </div>
            </div>
          `;
        } else {
          priceResultDiv.innerHTML = `
            <div class="text-center text-red-600 py-6">
              <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
              <div class="text-xl font-bold mb-2">خطا در پیش‌بینی</div>
              <p>${result.message || 'خطای ناشناخته رخ داده است'}</p>
            </div>
          `;
        }
      } catch (err) {
        console.error(err);
        priceResultDiv.innerHTML = `
          <div class="text-center text-red-600 py-6">
            <i class="fas fa-wifi-slash text-4xl mb-3"></i>
            <div class="text-xl font-bold mb-2">خطا در ارتباط با سرور</div>
            <p class="text-gray-600">لطفاً اتصال اینترنت خود را بررسی کنید</p>
          </div>
        `;
      }
    });

    // تابع به‌روزرسانی نمودار با پیش‌بینی جدید
    window.updateChartWithPrediction = function(price) {
      if (priceChart && typeof priceChart.update === 'function') {
        const priceInMillion = Math.round(price / 1000000);
        let rangeIndex;
        
        if (priceInMillion < 200) rangeIndex = 0;
        else if (priceInMillion < 400) rangeIndex = 1;
        else if (priceInMillion < 600) rangeIndex = 2;
        else if (priceInMillion < 800) rangeIndex = 3;
        else if (priceInMillion < 1000) rangeIndex = 4;
        else rangeIndex = 5;
        
        // افزایش مقدار در رنج مربوطه
        priceChart.data.datasets[0].data[rangeIndex]++;
        priceChart.update();
        
        // نمایش پیام
        showNotification('نمودار با پیش‌بینی جدید به‌روزرسانی شد', 'success');
      } else {
        showNotification('خطا در به‌روزرسانی نمودار', 'error');
      }
    };

    // تابع نمایش نوتیفیکیشن
    function showNotification(message, type = 'success') {
      // حذف نوتیفیکیشن‌های قبلی
      const existingNotifications = document.querySelectorAll('.notification');
      existingNotifications.forEach(n => n.remove());
      
      const notification = document.createElement('div');
      notification.className = `notification fixed bottom-4 left-4 ${type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700'} border px-4 py-3 rounded-lg shadow-lg z-50 transition-opacity duration-300`;
      notification.innerHTML = `
        <div class="flex items-center">
          <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} ml-2"></i>
          <span>${message}</span>
        </div>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 300);
      }, 3000);
    }

    // بارگذاری دقت مدل و ایجاد نمودار اولیه
    document.addEventListener('DOMContentLoaded', () => {
      console.log("صفحه بارگذاری شد، ایجاد نمودار...");
      loadModelAccuracy();
      fillTestData(); // برای محیط تست
    });
  </script>
</body>
</html>
